// Generated by CoffeeScript 1.3.3
var Client, METHODS, ahr2, apiMethod, method, _errorHandler, _request;

ahr2 = require('ahr2');

METHODS = require('./methods');

module.exports = Client = (function() {

  function Client(auth, options) {
    var version;
    this.auth = auth;
    if (options == null) {
      options = {};
    }
    version = options.version || 1;
    this.url = "http://api.simpleupc.com/v" + version + ".php";
  }

  return Client;

})();

for (method in METHODS) {
  apiMethod = METHODS[method];
  Client.prototype[method] = (function(apiMethod) {
    if (method === 'products') {
      return function(params, cb) {
        _request.call(this, apiMethod, params, cb);
      };
    } else {
      return function(upc, cb) {
        _request.call(this, apiMethod, {
          upc: upc
        }, cb);
      };
    }
  })(apiMethod);
}

_request = function(method, params, cb) {
  ahr2({
    href: this.url,
    headers: {
      'Content-Type': 'application/json'
    },
    encodedBody: JSON.stringify({
      auth: this.auth,
      method: method,
      params: params
    })
  }).when(function(err, ahr, data) {
    _errorHandler(err, data, cb);
  });
};

_errorHandler = function(err, data, cb) {
  if (data && !data.success) {
    cb(data.error, data);
  } else {
    cb(err, data);
  }
};
